function QaudioXHR(a,b){var c=Q.defer(),d=new XMLHttpRequest;return d.open("GET",b,!0),d.responseType="arraybuffer",d.onload=function(){a.decodeAudioData(d.response,c.resolve,c.reject)},d.onerror=c.reject,d.send(),c.promise}function QaudioFileInput(a,b){var c=Q.defer(),d=new FileReader;return d.onload=function(){a.decodeAudioData(this.result,c.resolve,c.reject)},d.onerror=c.reject,d.readAsArrayBuffer(b.files[0]),c.promise}var Encoder={};Encoder.floatTo16BitPCM=function(a,b,c){for(var d=0;d<c.length;d++,b+=2){var e=Math.max(-1,Math.min(1,c[d]));a.setInt16(b,0>e?32768*e:32767*e,!0)}},Encoder.trackFloatTo16BitPCM=function(a,b){for(var c=0;c<input.length;c++,b+=2){var d=Math.max(-1,Math.min(1,input[c]));a.setInt16(b,0>d?32768*d:32767*d,!0)}},Encoder.writeString=function(a,b,c){for(var d=0;d<c.length;d++)a.setUint8(b+d,c.charCodeAt(d))},Encoder.interleave=function(a){for(var b=a.length,c=a[0].length*b,d=new Float32Array(c),e=0,f=0;c>e;){for(var g=0;b>g;g++)d[e++]=a[g][f];f++}return d},Encoder.encodeWAV=function(a){function b(a){var b=Encoder.interleave(a),c=44100,d=new ArrayBuffer(44+2*b.length),e=new DataView(d);return Encoder.writeString(e,0,"RIFF"),e.setUint32(4,32+2*b.length,!0),Encoder.writeString(e,8,"WAVE"),Encoder.writeString(e,12,"fmt "),e.setUint32(16,16,!0),e.setUint16(20,1,!0),e.setUint16(22,a.length,!0),e.setUint32(24,c,!0),e.setUint32(28,4*c,!0),e.setUint16(32,4,!0),e.setUint16(34,16,!0),Encoder.writeString(e,36,"data"),e.setUint32(40,2*b.length,!0),Encoder.floatTo16BitPCM(e,44,b),e}return b(a)},Zampling.Chunk=function(a,b){this.samples=a,this.audioBuffer=b},Zampling.Chunk.prototype.clone=function(a){var b=a.createBuffer(1,this.samples.length,a.sampleRate);return new Zampling.Chunk(b.getChannelData(0),b)},Zampling.Chunk.prototype.split=function(a,b){var c=b.createBuffer(1,a,b.sampleRate),d=b.createBuffer(1,this.samples.length-a,b.sampleRate),e=c.getChannelData(0),f=d.getChannelData(0);e.set(this.samples.subarray(0,a)),f.set(this.samples.subarray(a,this.samples.length));var g=new Zampling.Chunk(e,c),h=new Zampling.Chunk(f,d);return[g,h]},Zampling.ChunkNode=function(a,b){this.chunk=a,this.next=b},Zampling.ChunkNode.prototype.clone=function(){return new Zampling.ChunkNode(this.chunk,this.next)},Zampling.ChunkNode.prototype.forEach=function(a,b){a.call(b,this),this.next&&this.next.forEach(a,b)},Zampling.ChunkNode.prototype.take=function(a){if(0==a)return null;var b=this.clone();return b.next=this.next.take(a-1),b},Zampling.ChunkNode.prototype.last=function(a){return this.next?this.next.last(a):this.next=a,this},Zampling.ChunkNode.prototype.reverse=function(){var a=this.clone();a.next=null;var b=a;return this.next&&(b=this.next.reverse(),b.last(a)),b},Zampling.ChunkNode.prototype.split=function(a,b){var c=this.chunk.split(a,b),d=new Zampling.ChunkNode(c[1],this.next);return this.chunk=c[0],this.next=d,this},Zampling.Player=Backbone.Model.extend({defaults:{playing:!1},initialize:function(){this.ctx=new(window.webkitAudioContext||window.AudioContext);var a=this.ctx.createDynamicsCompressor();a.connect(this.ctx.destination),this.destination=a;var b=this.ctx.createGain();b.gain.value=1,b.connect(a),this.tracks=new Zampling.Tracks,this.sources=[],this.triggerPlaying=_.bind(this._triggerPlaying,this),this.set("playing",!1)},_triggerPlaying:function(){this.trigger("playing",this.ctx.currentTime-this.get("playStartAt")+this.get("playPosition"))},play:function(a,b){if(a||(a=0),b||(b=1/0),!this.get("playing")){this.set("playing",!0),this.set("playPosition",a);var c=this.ctx.currentTime;this.set("playStartAt",c),this.trigger("playing",this.ctx.currentTime-this.get("playStartAt")+this.get("playPosition"));var d=-1/0;this.tracks.each(function(e){var f=-a;e.get("chunks").forEach(function(a){var e=this.ctx.createBufferSource();e.buffer=a.chunk.audioBuffer,e.connect(this.destination);var g=a.chunk.audioBuffer.duration,h=f;if(b>f&&(f+=g,f>0)){var i=Math.max(0,g-f),j=Math.min(g,b-f);e.start(c+h,i,j),d=Math.max(h+j,d),this.sources.push(e)}},this)},this),playendPromise=Q.delay(1e3*d),playendPromise.then(_.bind(this.stop,this)),setInterval(this.triggerPlaying,100),this.trigger("play",playendPromise)}},stop:function(){this.get("playing")&&(this.sources.forEach(function(a){a.stop(0)}),this.sources=[],clearInterval(this.triggerPlaying),this.set("playing",!1),this.trigger("stop"))}}),Zampling.Track=Backbone.Model.extend({defaults:{width:600,height:100,zoom:.01,scrollX:0},initialize:function(){},getCursorStartTime:function(){return this.get("cursorstartx")/(this.get("zoom")*this.get("ctx").sampleRate)},getCursorEndTime:function(){return this.get("cursorendx")/(this.get("zoom")*this.get("ctx").sampleRate)},getStat:function(a,b){for(var c=1/0,d=-1/0,e=0,f=this.get("chunks"),g=f.chunk.samples.length,h=a;b>h;++h){for(;f&&h>e+g;)e+=g,f=f.next,f&&(g=f.chunk.samples.length);if(!f)break;var i=f.chunk.samples[h-e];c>i&&(c=i),i>d&&(d=i)}return{min:c,max:d}},cut:function(a,b){var c,d=this.get("chunks"),e=d.chunk.samples.length;for(c=e;a>c;c+=e)d=d.next,e=d.chunk.samples.length;0!==c-a&&(d=d.split(e-(c-a),this.get("ctx")));var f,g=d.next,h=g,i=h.chunk.samples.length,j=b-a;for(f=i;j>f;f+=i)h=h.next,i=h.chunk.samples.length;return 0===f-j?(d.next=h.next,h.next=null):(h=h.split(i-(f-j),this.get("ctx")),d.next=h.next,h.next=null),this.trigger("change:chunks",this,this.get("chunks")),g},insert:function(a,b){var c,d=this.get("chunks"),e=d.chunk.samples.length;for(c=e;b>c;c+=e)d=d.next,e=d.chunk.samples.length;c!=b&&(d=d.split(e-(c-b),this.get("ctx")));for(var f=a;f.next;)f=f.next;f.next=d.next,d.next=a,this.trigger("change:chunks",this,this.get("chunks"))},copy:function(){throw"Not Implemented"},length:function(){for(var a=0,b=this.get("chunks");void 0!=b;)a+=b.chunk.samples.length,b=b.next;return a},toFloat32Array:function(){for(var a=this.length(),b=this.get("chunks"),c=new Float32Array(a),d=0;void 0!=b;){for(var e=0;e<b.chunk.samples.length;e++)c[d++]=b.chunk.samples[e];b=b.next}return c}},{DEFAULT_SAMPLES_SIZE:44100,createFromArrayBuffer:function(a,b,c){if(!a||0===a.length)throw"float32ArrayBuffer is empty.";c||(c=Zampling.Track.DEFAULT_SAMPLES_SIZE);for(var d=a.length,e=[],f=0;d>f;f+=c){var g=Math.min(d-f,c),h=b.createBuffer(1,g,b.sampleRate),i=h.getChannelData(0);i.set(a.subarray(f,f+g));var j=new Zampling.Chunk(i,h);e.push(j)}var k=_.reduceRight(e,function(a,b){return new Zampling.ChunkNode(b,a)},null);return new Zampling.Track({chunks:k,ctx:b})}}),Zampling.Tracks=Backbone.Collection.extend({model:Zampling.Track}),Zampling.ControlsView=Backbone.View.extend({initialize:function(){this.$div=$('<div class="blue ui buttons" style="margin:10px"></div>'),this.$play=$('<div class="ui icon button play"><i class="play icon"></i></div>'),this.$stop=$('<div class="ui icon button stop"><i class="stop icon"></i></div>'),this.$export=$('<div class="ui right labeled icon button download green"><i class="right download disk icon"></i>Download</div>'),this.$zoomin=$('<div class="zoomin ui icon button"><i class="zoom in icon"></i></div>'),this.$zoomDiv=$('<div class="blue ui buttons" style="margin:10px"></div>'),this.$zoomout=$('<div class="zoomout ui icon button"><i class="zoom out icon"></i></div>'),this.$opDiv=$('<div class="blue ui buttons" style="margin:10px"></div>'),this.$cut=$('<div class="cut ui icon button"><i class="cut icon"></i></div>'),this.$paste=$('<div class="paste ui icon button"><i class="paste icon"></i></div>'),this.$div.append(this.$play),this.$div.append(this.$stop),this.$el.append(this.$div),this.$el.append(this.$export),this.$zoomDiv.append(this.$zoomin),this.$zoomDiv.append(this.$zoomout),this.$el.append(this.$zoomDiv),this.$opDiv.append(this.$cut),this.$opDiv.append(this.$paste),this.$el.append(this.$opDiv)},events:{"click .play":"onPlay","click .stop":"onStop","click .download":"onDownload","click .zoomin":"onZoomIn","click .zoomout":"onZoomOut","click .cut":"onCut","click .paste":"onPaste"},onPlay:function(){this.model.trigger("button-play")},onStop:function(){this.model.trigger("button-stop")},onDownload:function(){this.model.trigger("button-download")},onZoomIn:function(){this.model.trigger("button-zoomin")},onZoomOut:function(){this.model.trigger("button-zoomout")},onCut:function(){this.model.trigger("button-cut")},onPaste:function(){this.model.trigger("button-paste")}}),Zampling.TrackView=Backbone.View.extend({className:"track",initialize:function(){this.MIN_DELTA=8,this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.$cursor=$('<div class="cursor"></div>'),this.$selection=$('<div class="selection"></div>'),this.listenTo(this.model,"change:width change:height",this.syncSize),this.listenTo(this.model,"change:zoom",this.render),this.listenTo(this.model,"change:chunks",this.render),this.listenTo(this.model,"change:cursorstartx change:cursorendx",this.syncCursor),this.listenTo(this.model,"change:cursormode",this.syncCursorMode),this.$el.append(this.canvas),this.$el.append(this.$cursor),this.$el.append(this.$selection),this.syncSize()},events:{mousedown:"onMouseDown",mouseup:"onMouseUp",mousemove:"onMouseMove"},onMouseDown:function(a){a.preventDefault();var b=a.clientX-this.canvas.getBoundingClientRect().left;this.model.set({cursormode:"cursor",cursorstartx:b,cursorendx:null,moving:!0})},onMouseUp:function(a){var b=a.clientX-this.canvas.getBoundingClientRect().left;this.model.set({cursorendx:b,moving:!1})},onMouseMove:function(a){if(this.model.get("moving")){var b=a.clientX-this.canvas.getBoundingClientRect().left;this.model.set("cursorendx",b)}},syncCursorMode:function(){var a=this.model.get("cursormode");"cursor"==a?(this.$cursor.show(),this.$selection.hide()):"selection"==a&&(this.$selection.show(),this.$cursor.hide())},syncCursor:function(){var a=this.model.get("cursorstartx"),b=this.model.get("cursorendx");Math.abs(a-b)<this.MIN_DELTA?(this.model.set("cursormode","cursor"),this.$cursor.css({left:Math.round(a)+"px"})):(this.model.set("cursormode","selection"),this.$selection.css({left:Math.round(a)+"px",width:Math.round(b-a)+"px"}))},syncSize:function(){var a=this.model.get("width"),b=this.model.get("height"),c=window.devicePixelRatio||1;this.canvas.width=c*a,this.canvas.height=c*b,this.canvas.style.width=a+"px",this.canvas.style.height=b+"px",this.render()},render:function(){var a=this.ctx,b=a.canvas.width,c=a.canvas.height,d=window.devicePixelRatio||1,e=this.model.get("zoom"),f=Math.floor(1/(e*d));a.clearRect(0,0,a.canvas.width,a.canvas.height),a.fillStyle="#6ECFF5";var g=0;if(!(1>e))throw"zoom level >= 1, Not Implemented";for(var h=0;b>h;++h){var i=this.model.getStat(g,g+f),j=c*(1-(i.max+1)/2),k=c*(1-(i.min+1)/2);a.fillRect(h,j,1,k-j),g+=f}}}),navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,function(){function a(a){var b=2048,d=c.createJavaScriptNode(b,1,1);return d.onaudioprocess=function(d){var e=c.createBuffer(1,b,c.sampleRate),f=new Float32Array(d.inputBuffer.getChannelData(0));e.getChannelData(0).set(f),a({buffer:e,array:f})},d}var b=$("#tracks"),c=new(window.webkitAudioContext||window.AudioContext),d=new Zampling.Player;new Zampling.ControlsView({model:d,el:$("#controls")}),d.tracks.on("add",function(a){var c=new Zampling.TrackView({model:a});c.$el.appendTo(b),a.on("change:cursormode",function(){d.set("currentTrack",a)})});var e=$('<div class="play-cursor" />');e.hide(),b.append(e),d.on("play",function(){e.show()}),d.on("stop",function(){e.hide()}),d.on("playing",function(a){var b=Math.round(a*c.sampleRate*d.get("zoom"));e.css("left",b+"px")});var f;$("input[type='file']").change(function(){QaudioFileInput(c,this).then(function(a){return f=a,Zampling.Track.createFromArrayBuffer(a.getChannelData(0),c)}).then(function(a){d.tracks.add(a)})}),d.on("change:zoom",function(a,b){d.tracks.each(function(a){a.set("zoom",b)})}),d.tracks.on("add",function(a){a.set("zoom",d.get("zoom"))});var g,h=1.5;d.set("zoom",g=.001),d.on("button-zoomin",function(){var a=g*h;1>a&&this.set("zoom",g=a)}),d.on("button-zoomout",function(){var a=g/h;this.set("zoom",g=a)});var i;d.on("button-cut",function(){var a=d.get("currentTrack"),b=a.getCursorStartTime(),e=a.getCursorEndTime();i=a.cut(Math.round(b*c.sampleRate),Math.round(e*c.sampleRate))}),d.on("button-paste",function(){if(i){var a=d.get("currentTrack"),b=a.getCursorStartTime();a.insert(i,Math.round(b*c.sampleRate)),i=null}}),d.on("button-play",function(){var a=d.get("currentTrack");if(a){var b=a.get("cursormode"),c=a.getCursorStartTime(),e=a.getCursorEndTime();"cursor"===b?d.play(c):d.play(c,e)}else d.play()}),d.on("button-stop",function(){d.stop()}),d.on("button-download",function(){var a=Encoder.encodeWAV([d.tracks.head().toFloat32Array()]),b=new Blob([a],{type:"audio/wav"}),c=URL.createObjectURL(b),e=document.createElement("a");e.href=c,e.download=(new Date).toISOString()+".wav",e.innerHTML=e.download;var f=document.createEvent("Event");f.initEvent("click",!0,!0),e.dispatchEvent(f)});var j=function(a){return navigator.getUserMedia({audio:!0},a.resolve,a.reject),a.promise}(Q.defer()),k=null,l=null,m=null;$("#record").click(function(){j.then(function(b){k=b,$("#stopRecord").show();var e=c.createDynamicsCompressor();e.connect(c.destination);var f=c.createGain();f.gain.value=2,f.connect(e);var g=null;m=a(function(a){if(g){var b=new Zampling.ChunkNode(new Zampling.Chunk(a.array,a.buffer));g.insert(b,g.length())}else g=Zampling.Track.createFromArrayBuffer(a.array,c),d.tracks.add(g)}),m.connect(f),l=c.createMediaStreamSource(b),l.connect(m)})}),$("#stopRecord").hide().click(function(){k.stop(),k=null,l.disconnect(0),m.disconnect(0),$(this).hide()})}();